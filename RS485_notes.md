# 1. RS-485笔记
## 1.1. 参考文档
1. [所有笔记](https://github.com/SuperChange001/hw_learning_material)
2. [TI Precision LABS](https://training.ti.com/ti-precision-labs-interface?context=1139747-1138099)
2. [Frequently asked questions and answers for RS-485 transceivers](https://e2e.ti.com/blogs_/b/analogwire/archive/2019/04/09/frequently-asked-questions-and-answers-for-rs-485-transceivers)
2. [RS-422 and RS-485 Standards Overview and System Configurations](https://www.ti.com/lit/an/slla070d/slla070d.pdf?ts=1598241208035&ref_url=https%253A%252F%252Fwww.google.com%252F)
3. [when-termination-is-necessary-and-how-to-do-it-properly](https://e2e.ti.com/blogs_/b/analogwire/archive/2016/07/28/rs-485-basics-when-termination-is-necessary-and-how-to-do-it-properly)
4. [RS-485 basics: the RS-485 receiver](https://e2e.ti.com/blogs_/b/analogwire/archive/2016/02/09/rs-485-basics-the-rs-485-receiver)


## 1.2. 名词解释
- TIA：Telcommunication Industries Alliance 标准委员会
- EIA：Electronic Industries Alliance 标准委员会
- UL：unit load
- GPD：ground potential difference
- CDM：charged device model (CDM) 
- HBM：human body model (HBM)


# 2. 总结
设计一个RS485电路：
1. 拓扑：全双工，半双工。
2. 节点数 UL
2. 终端匹配方式
3. 接地方式：GPD模型是怎么样的
4. 速率和走线长度的关系
5. 需要考虑failsafe么？线路短路、断路和idle时，接收器不能处于中间态

## 2.1. 注意点
1. RS485只是定义了物理层，电气规范。协议没有定，流行的有modbus。
2. 5V和3V3的RS485可以直接混用通信。但是避免那么做
	1. 带来的问题是共模电压会有跳变，EMI会强一点。
2. TIA规定的最大PE电势差是±7V。工作电压0 - 5V，所以共模电压-7 - 12V
3. 驱动方式就是H桥，所以是平衡传输的。从电阻一端流入，另一端流出，电流一样。
	1. 不同于CAN，CAN是个开漏输出。CAN因此有dominant和recessive的说法，可以用于总线的非破坏性的仲裁。
4. 通信：
	1. 协议方面，根据协议来。
	2. 常规的，通信都是主机发起，从机应答。没有总线仲裁，采用一问一答的方式防止冲突。
3. 拓扑：
	1. 常用的是半双工，A接A，B接B。收发一条线
	2. 全双工：主机的YZ接从机AB，从机的YZ接主机的AB。两条线
3. 走线接法：
	3. 屏蔽双绞线：抑制辐射，抑制共模干扰
	4. 用backbon接法：stub一定要短，长了一样会反射
	4. 菊花链接法：一个推一个，但是不是真正的菊花链
4. 终端电阻
	1. 两个终端电阻，在两头。120欧，等于双绞线的阻抗。
	2. 走线短，且小于200kbps，可以不要
	3. 有个大负载的电阻，就不容易被噪声干扰抬升很大的电平
1. 节点数量：
	1. 根据TIA的规定，是32个UL。凡是节点的负载可以是1/n个UL，就可以接很多个
5. 速率和线长
    - 速度：规定是小于10M
    - 线长：规定是小于1200m
    - 经验公式：速度*线长<10^8
   	 - 速度快：10M，信号的上升沿不够优化
        - 线很长：1200m的导线电阻就有120o，衰减了Vod
        - 中间段：导线组成了RC滤波，限制了方波的高频部分
        - 采样率和线长的关系：![](https://gitee.com/AndrewChu/markdown/raw/master/1598240272_20200822135200813_1196182673.png )


# 3. 和其他总线比较
## 3.1. 485和232的区别
232：
- 是一发一收，信号参考的GND。是单端信号。
- 单对单的，所以加节点很麻烦
- 不是差分传输，所以速度和距离都跟不上
- 这些特性，注定232只能用来做debug的接口

## 3.2. 485和422的区别
1. 兼容性：
	1. 485IC可以用在422，反过来不行
	2. 就是485更加宽泛。
2. 两者的差别：
	1. 422：只能有一个driver。一个匹配电阻。最多10个负载，一个负载4K等效阻抗。
	2. 共模电压范围：正负7。485是-7~12V
	3. 冲突保护机制：过流限值不一样

## 3.3. 485和CAN的区别
1. CAN明显是更加安全可靠的多节点传输的协议+物理层。
2. GPD：
	1. 485：±7V
	2. CAN：-2  - 7V
1. 总线仲裁：
	1. 485：没有仲裁，是损坏性质的，过流之后依靠IC散热
	2. CAN：依靠dominant和recessive进行总线仲裁，没有破坏性
1. tranceiver的结构：
	1. 485：H桥，是强的0/1
	2. CAN：开漏形式，强0弱1
1. 协议：
	1. CAN已经定义了数据格式，报头和数据，包括了stuffing。错误处理机制。
	2. 485：只定义了物理层的电气特性，没有任何协议。

# 4. 485的物理结构
## 4.1. Driver 物理结构
就是H桥电路，4个二极管是为了单相流通性
TIA规定了输出Vod在54欧的电阻上，可以产生1.5V压降
这个结构也决定了是平衡传输的，同时也是强0/1输出
driver的结构：![](https://gitee.com/AndrewChu/markdown/raw/master/1598240281_20200824113713545_1025546916.png )
## 4.2. Receiver 物理结构
- 衰减电路+差分输入：
	- 衰减电路：
		- 衰减+搬移电平到2.5V
		- 在共模电压很高，输入是7和12V的时候就很必要。针对GPD优化
		- 缺点：
			- 接收器有负载了，那就不能无限加负载了。所以有了UL。标准的32个
			- 那么把电阻无限做大：不行。电阻越大，die越大，导致寄生电容越大，RC低通效果越明显。导致带宽下来了。所以UL大的，才能把速度做上去
	- 差分电路：
		- 判断Vid，决定输出状态。
		- failsafe：就是正常使用，不会出现输出电平不确定的状态。
		- TIA没有规定Vid的阈值，对应的输出。TIA只规定了正200mV输出是正
			- 为了做failsafe，厂家把Vid规定为 -200mv<Vit-<x<Vit+<-20mV。至少保证40mV
			- 实现了。idle，短路，断路的输出都是1.
	- 看了TI的级数文档，没有提到负载的容抗？
		- 因为比较难以计算，要考虑走线，管脚，IC内部
		- 考虑到信号传输的上升沿，fmax对应的容抗应该也很大，所以可以省略
receiver的结构：![](https://gitee.com/AndrewChu/markdown/raw/master/1598240280_20200824113548768_1278135058.png )
厂家规定的阈值：![](https://gitee.com/AndrewChu/markdown/raw/master/1598240281_20200824113644075_336998865.png )

## 4.3. 总线仲裁
RS485没有仲裁。意味着两个输出端都可以输出，最终导致了总线短路。
这就叫冲突保护，有过流保护250mA最大，然后等IC降温。

# 5. Failsafe
failsafe：就是正常使用，不会出现输出电平不确定的状态。
旧的IC可能需要外置电阻实现这个功能，新的IC都内置了。

1. IC内置：
	2. 新的芯片都内置了，老的不一定有。
2. 外置：
	1. 一般在源端的Rt上再加两个Rfs分别接到VCC和GND
	2. 一般不用这种方式
	3. 加了种负载，要计算等于多少个UL


# 6. 负载数量计算
- 能接多少的负载：
   - TIA规定的是发送端驱动能力：54欧的负载，产生1.5V的Vid.
   - 54欧是：2个120，32个12K负载。
   - 标准UL：输入器件在12V的时候，电阻最小。有1ma输入漏电流，等效于负载是12K，可以带32个。
   - Unit load大的器件，带宽越大。因为衰减网络里的分压电阻小，寄生电容小了。但是能连接的节点数量就少了


# 7. 接地方式
GPDs：groud potential differance
4种方式：
1. 不接地线，要求两边的gnd都接到PE：（最不推荐）
	1. 依靠PE是等电势的，但是TIA的规定是电势差要在±7V内。
	2. 设备单点接PE，那么内部485可以都直接接到PE上
	3. 设备多点接PE，不能保证各个PE之间电势差，很有可能大电流从设备的PE上走，那就回导致大的PE电势差。这样接会烧IC
2. 接地线，同时两边的gnd都接到PE：
	1. 一般都是这样做的。这样的也有坏处：PE current loop
	3. PE的大电流直接从485的gnd线走了，走线有电阻，导致两端电压差很大，直接烧IC
3. 接地线，两边的gnd都接到PE都串联100欧电阻：
	1. TIA推荐做法
	2. 还是有一定的风险。
	3. 两边都PE电势差，电压都是加到两个电阻上，gnd的压差不大。保护了器件
	4. 我们之前的做法：小电容+TVS+电阻
4. 接地线+隔离：
	1. 最优的隔离程度，但是最贵的。外加隔离电源+隔离芯片
	2. 可以耐受几千伏的GPD，两个设备之间，只有通信线是连接的。其他电路都站在那么高的GPD上也没事。只要把隔离的电源，gnd，信号互相连起来就行。
	3. 高压和主控板为什么要隔离的原因。

## 7.1. 隔离485的设计：
- 1. 隔离电源
- 2. 信号隔离芯片
- 3. 485收发芯片
1和2可以做在一起，2和3可以做在一起。
如果把1和2做在一起，可以没有变压器，认证很方便。板子空间也小，但是效率做不高，而且f很高，emi也差。

# 8. 端接方式
3种端接方式：
1. 不推荐：无终端电阻：
	1. 走线短，且小于200kbps，可以不要
2. 并联120欧终端电阻：
	1. 最常见，但是直流功耗很大
	2. 两端都要加。反射是两端都在进行的
3. 并联120欧+电容终端电阻
	1. 不常见，但是直流功耗小。会引入一个RC滤波常数，影响了上升沿，影响了速度。
	2. 对高频是120欧的电阻：把容易反射的部分，都给匹配了，就不会反射了
	3. 对低频是开路：会反射
4. 并联2个60欧，中点解电容接到gnd
	1. 对共模干扰的抑制最强，代价就是会牺牲一定的上升时延

## 8.1. 传输线反射
1. 传输线效应：导线长度和波长可以比拟的时候，就要考虑线缆的特性阻抗，穿过不同介质的时候，会反射。
	1. 理论上：如果上升沿小于3倍传输延时，就要考虑传输线效应。
		1. 推导：
			1. 上升时间Tr，传输延时Td，波形的最高频率fmax，n=导线长度/波长
			2. fmax=0.35/Tr  c=λfmax   Td=l/c=l/(λ*fmax)=0.35*n*Tr
			3. n=Td*3/Tr>1  就可以推导出以上的结论。
	2. 工程上：或者只有当bit time和loop time一样的时候
		1. 推导：
			1. 方波是基波的奇次谐波，幅度依次衰减。
			2. 只要保证基波附近的波不要发生反射就行。高次谐波就算每次满能量反射，其实能量也不大
			3. loop time：信号从一端到另外一端的时间
			4. bit time：一个电平信号，占有的时间。
			5. bit time说明了信号维持的时间，和采样的位置。当bit time远远大于loop time，那就采样到的就是一直维持的电平。
2. 举例：
    - ![IMG_0944](https://gitee.com/AndrewChu/markdown/raw/master/1600057942_20200914123217717_1514374538.jpg)
    - 如果信号从一条线的一端到另一端需要0.5s，然后反射系数是1/2，就是有一半信号被反射回去
    - 那么在一个时间点测量一个信号，就会测到1s前的信号的1/4, 2s前的信号的1/16. 这个信号就被污染了
    - 所以，我们会要求，在一个信号的一半时间的位置测量，那么他的1s 2s前的时间都是他本身。
        - 如果是1，那么测到的会比1大一点
        - 如果是0，那么测到的就是0，而不会被干扰。
    - 所以只有当bit time和loop time一样的时候，才要加匹配电阻


# 9. 防护
具体的EMC测试原理，会在专门章节说明。

能量排序：ESD<EFT<Surge
- ESD：
	- 有CDM和HDM两种，但是我们一般就是看IEC61000-4测试程度，一般器件本身就可以做到ESD±16KV
	- 要是不放心，可以在外面再加防护器件如TVS
- EFT：
	- 有些标准是对于长于3m的线缆才要做，同时也要区分清楚信号线和电源线的区别
	- 对于屏蔽和非屏蔽的测试标准也不一样。
- Surge：
	- 外接TVS

一般的防护方式：
- TVS：考虑电容对于信号的影响。选择的Vr和Vbr的值。TVS的压电效应，引发交流信号的畸变，THD变差
	1. Vr：完全不工作，漏电流很小，不会干扰器件正常工作
	2. Vbr：开始工作，电流1ma
	3. Vc：完全工作
- R或者PTC：可以在通信串联一个小R，进行过流抑制。很少见PTC，除非持续过流
- choke：可以抑制共模干扰，也可以抑制共模发射。要注意铜损和磁损
- 小电容：可以吸收一定的干扰
